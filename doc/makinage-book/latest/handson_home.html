<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Energy Consumption &mdash; The Maki Nage Book  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/tabs.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lanl" href="handson_lanl.html" />
    <link rel="prev" title="Hands-on" href="handson.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> The Maki Nage Book
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="rationale.html">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="handson.html">Hands-on</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Home Energy Consumption</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-dataset">The dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-exploration">Data Exploration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overall-consumption">Overall Consumption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multiple-variables-exploration">Multiple Variables Exploration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#feature-engineering">Feature Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#training">Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deployment">Deployment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Feature Engineering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-serving">Model Serving</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="handson_lanl.html">Lanl</a></li>
<li class="toctree-l2"><a class="reference internal" href="handson_lanl_online.html">Lanl Online</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="serving.html">Model serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="howto.html">How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">The Maki Nage Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="handson.html">Hands-on</a> &raquo;</li>
      <li>Home Energy Consumption</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="home-energy-consumption">
<h1>Home Energy Consumption<a class="headerlink" href="#home-energy-consumption" title="Permalink to this headline"></a></h1>
<p>This first tutorial explains how to use Maki Nage for basic feature engineering
on time-series data, and how to deploy a model operating in streaming mode. The
task of this tutorial is a regression: We will predict the power consumption of
a house, based on weather information.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Maki Nage is designed to work efficiently with <a class="reference external" href="https://www.pypy.org/">pypy</a>. Please ensure that you use it as your interpreter
for better performance.</p>
</div>
<section id="the-dataset">
<h2>The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this headline"></a></h2>
<p>In this example, we will work on the <em>Smart Home Dataset</em>. It can be downloaded from
kaggle <a class="reference external" href="https://www.kaggle.com/taranvee/smart-home-dataset-with-weather-information">here</a>.</p>
<p>The dataset is a CSV file of 130MB, its content looks like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>head HomeC.csv
<span class="go">time,use [kW],gen [kW],House overall [kW],Dishwasher [kW],Furnace 1 [kW],Furnace 2 [kW],Home office [kW],Fridge [kW],Wine cellar [kW],Garage door [kW],Kitchen 12 [kW],Kitchen 14 [kW],Kitchen 38 [kW],Barn [kW],Well [kW],Microwave [kW],Living room [kW],Solar [kW],temperature,icon,humidity,visibility,summary,apparentTemperature,pressure,windSpeed,cloudCover,windBearing,precipIntensity,dewPoint,precipProbability</span>
<span class="go">1451624400,0.932833333,0.003483333,0.932833333,3.33E-05,0.0207,0.061916667,0.442633333,0.12415,0.006983333,0.013083333,0.000416667,0.00015,0,0.03135,0.001016667,0.004066667,0.001516667,0.003483333,36.14,clear-night,0.62,10,Clear,29.26,1016.91,9.18,cloudCover,282,0,24.4,0</span>
<span class="go">1451624401,0.934333333,0.003466667,0.934333333,0,0.020716667,0.063816667,0.444066667,0.124,0.006983333,0.013116667,0.000416667,0.00015,0,0.0315,0.001016667,0.004066667,0.00165,0.003466667,36.14,clear-night,0.62,10,Clear,29.26,1016.91,9.18,cloudCover,282,0,24.4,0</span>
<span class="go">1451624402,0.931816667,0.003466667,0.931816667,1.67E-05,0.0207,0.062316667,0.446066667,0.123533333,0.006983333,0.013083333,0.000433333,0.000166667,1.67E-05,0.031516667,0.001,0.004066667,0.00165,0.003466667,36.14,clear-night,0.62,10,Clear,29.26,1016.91,9.18,cloudCover,282,0,24.4,0</span>
</pre></div>
</div>
<p>For simplicity, We will use only a few columns:</p>
<ul class="simple">
<li><p>House overall: This is the label we want to predict, the total energy consumption of the house.</p></li>
<li><p>temperature: The weather temperature in °F.</p></li>
<li><p>pressure: The atmospheric pressure in hPa (hectopascal).</p></li>
<li><p>windSpeed: The wind speed.</p></li>
</ul>
<p>We will use the following imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">rx</span>
<span class="kn">import</span> <span class="nn">rx.operators</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">rxsci</span> <span class="k">as</span> <span class="nn">rs</span>
<span class="kn">import</span> <span class="nn">rxsci.container.csv</span> <span class="k">as</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">distogram</span>
</pre></div>
</div>
<p>The recommended data type when working with Maki Nage is namedtuple, hence the
first import. Then there are two RxPy imports. Since Maki Nage is based on
ReactiveX, we will use some ReactiveX operators. Then is the main RxSci import,
and another one to work with CSV files. RxSci is the Maki Nage library that
implements all transformation functions. It is the library that you will mostly
use in a Maki Nage application. The final import is used for the data
exploration phase when computing statistics on the data distributions.</p>
<p>With these imports, we can start a template code that will read the CSV file. The
first step consists of defining the schema of this CSV file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">&#39;/opt/dataset/HomeC.csv&#39;</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">create_line_parser</span><span class="p">(</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;gen&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;house_overall&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;dishwasher&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;furnace1&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;furnace2&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;home_office&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;fridge&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;wine_cellar&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;garage_door&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;kitchen_12&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;kitchen_14&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;kitchen_38&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;barn&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;microwave&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;living_room&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;humidity&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;apparent_temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;wind_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cloud_cover&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;wind_bearing&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;precip_intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;dew_point&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;precip_probability&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Then, loading and processing its content is done the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">csv</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Many things happen on this single line: The <em>load_from_file</em> function is a
factory operator that creates an Observable from the content of the CSV file. An
Observable is the term used for a stream of events. The Observable will emit one
item - one event - for each line of the CSV file. The <em>load_from_file</em> operator
takes two arguments: the path of the CSV file and its schema.</p>
<p>The pipe operator one of the two operators that you will use most frequently: It
allows you to create chains of operators, so that data transformations can be
done sequentially. For now, no sequence is provided, so no transformation is
done.</p>
<p>Finally, the run operator subscribes to the Observable. Calling it triggers the
actual execution of the whole computation graph.</p>
<p>Now that we have our CSV dataset available as an Observable, let’s work on it!</p>
</section>
<section id="data-exploration">
<h2>Data Exploration<a class="headerlink" href="#data-exploration" title="Permalink to this headline"></a></h2>
<section id="overall-consumption">
<h3>Overall Consumption<a class="headerlink" href="#overall-consumption" title="Permalink to this headline"></a></h3>
<p>As a first step, let’s compute some statistics on the <em>house overall</em> column,
and plot its histogram. For these two steps, we need to compute a compressed
representation of the data distribution. This is done by creating a graph that
consists of two operators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The map operator applies a transformation function for each item emitted by the
source Observable. Note that all operators take observables as input and return
Observables as output. This allows to chain operators very easily.</p>
<p>The second operator is <em>math.dist.update</em>. It computes a compressed
representation of the data distribution that can be used to compute statistics
on it, such as mean, variance, and quantiles. The reduce parameter indicates
that we want the operator to emit an item only when the source Observable
completes, i.e. when all items have been processed. The default behavior is to
emit a distribution object for each item received as input.</p>
<p>As said previously, the run operator subscribes to the resulting Observable.
Moreover, it returns that last item emitted. On our graph, this is the
distribution object.</p>
<p>From this object, we can do several statistical analyses. Computing classical
statistical information is done with the <em>describe</em> operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;house overall consumption statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</pre></div>
</div>
<p>Note that we still have the same structure here, always working with
Observables: First an observable is created from the dist object, with the
<em>just</em> operator. This observable will emit a single item. This may seem
unnecessarily complex at first, but when working in a streaming way, this is
just a particular case of a stream. The important point is that all the operators
that we use work on Observables, whether they emit no item, some items, or an
infinite number of items.</p>
<p>The <em>math.dist.describe</em> operator emits a namedtuple with the following
statistics for each item it receives:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>min</p></td>
<td><p>0.0</p></td>
</tr>
<tr class="row-even"><td><p>max</p></td>
<td><p>14.71456667</p></td>
</tr>
<tr class="row-odd"><td><p>mean</p></td>
<td><p>0.8589623950050789</p></td>
</tr>
<tr class="row-even"><td><p>stddev</p></td>
<td><p>1.0574552803110226</p></td>
</tr>
<tr class="row-odd"><td><p>p25</p></td>
<td><p>0.36709267099355347</p></td>
</tr>
<tr class="row-even"><td><p>p50</p></td>
<td><p>0.568152839202991</p></td>
</tr>
<tr class="row-odd"><td><p>p75</p></td>
<td><p>0.9730122941873172</p></td>
</tr>
</tbody>
</table>
<p>Another kind of information that can be computed from the dist object is the
histogram of the distribution. For this, we use once again the same pattern:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_hist</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">histogram</span><span class="p">(),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">])),</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_hist</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;house consumption&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The <em>math.dist.histogram</em> operator computes the histogram of the distribution.
Then this histogram object is mapped to a pandas dataframe so that it can be
used by plotly. The resulting plot is:</p>
<a class="reference internal image-reference" href="_images/home_house_consumption.png"><img alt="_images/home_house_consumption.png" class="align-center" src="_images/home_house_consumption.png" style="width: 560.0px; height: 360.0px;" /></a>
</section>
<section id="multiple-variables-exploration">
<h3>Multiple Variables Exploration<a class="headerlink" href="#multiple-variables-exploration" title="Permalink to this headline"></a></h3>
<p>In the previous section, we studied one feature. The first step consisted of
computing a compressed representation of the data distribution by using two
operators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">),</span>
<span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</pre></div>
</div>
<p>Now we want to do the same for other columns. One naive way is to do the same
steps for each feature. However, this means that we need to process the dataset
as many times as the features we have. Fortunately, all these steps can be done
in parallel, thanks to a dedicated operator: <em>tee_map</em>. The <em>tee_map</em> operator
applies several transformation graphs to the same source of data in parallel. So
if we want to compute four distributions on a single reading pass, we can do the
following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">tee_map</span><span class="p">(</span>
        <span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>  <span class="c1"># graph 1</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">),</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>  <span class="c1"># graph 2</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">),</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>  <span class="c1"># graph 3</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">pressure</span><span class="p">),</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>  <span class="c1"># graph 4</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">),</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we have four computation graphs - one for each feature - that are processed
in parallel. The final dist variable is a tuple of four fields, one for each
computation graph:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="p">(</span><span class="o">&lt;</span><span class="n">distogram</span><span class="o">.</span><span class="n">Distogram</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000000000af063d8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">distogram</span><span class="o">.</span><span class="n">Distogram</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x0000000008ca7b78</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">distogram</span><span class="o">.</span><span class="n">Distogram</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x0000000008ca7478</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">distogram</span><span class="o">.</span><span class="n">Distogram</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x0000000008ca6f00</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>From these dist objects, we can now print the statistics and histogram of the columns are previously:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;house_overall&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;wind_speed&#39;</span><span class="p">]</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> statistics:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>

    <span class="n">df_hist</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">histogram</span><span class="p">(),</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">])),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_hist</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>min</p></td>
<td><p>0.0</p></td>
</tr>
<tr class="row-even"><td><p>max</p></td>
<td><p>14.71456667</p></td>
</tr>
<tr class="row-odd"><td><p>mean</p></td>
<td><p>0.8589623950050789</p></td>
</tr>
<tr class="row-even"><td><p>stddev</p></td>
<td><p>1.0574552803110226</p></td>
</tr>
<tr class="row-odd"><td><p>p25</p></td>
<td><p>0.36709267099355347</p></td>
</tr>
<tr class="row-even"><td><p>p50</p></td>
<td><p>0.568152839202991</p></td>
</tr>
<tr class="row-odd"><td><p>p75</p></td>
<td><p>0.9730122941873172</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="_images/home_house_consumption.png"><img alt="_images/home_house_consumption.png" class="align-center" src="_images/home_house_consumption.png" style="width: 560.0px; height: 360.0px;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>min</p></td>
<td><p>-11.45</p></td>
</tr>
<tr class="row-even"><td><p>max</p></td>
<td><p>93.72</p></td>
</tr>
<tr class="row-odd"><td><p>mean</p></td>
<td><p>50.74525179099427</p></td>
</tr>
<tr class="row-even"><td><p>stddev</p></td>
<td><p>19.10129528623627</p></td>
</tr>
<tr class="row-odd"><td><p>p25</p></td>
<td><p>35.774367229171965</p></td>
</tr>
<tr class="row-even"><td><p>p50</p></td>
<td><p>50.37779947700175</p></td>
</tr>
<tr class="row-odd"><td><p>p75</p></td>
<td><p>66.26310350773754</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="_images/home_temperature.png"><img alt="_images/home_temperature.png" class="align-center" src="_images/home_temperature.png" style="width: 560.0px; height: 240.0px;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>min</p></td>
<td><p>986.4</p></td>
</tr>
<tr class="row-even"><td><p>max</p></td>
<td><p>1042.46</p></td>
</tr>
<tr class="row-odd"><td><p>mean</p></td>
<td><p>1016.3016253696112</p></td>
</tr>
<tr class="row-even"><td><p>stddev</p></td>
<td><p>7.893601267311901</p></td>
</tr>
<tr class="row-odd"><td><p>p25</p></td>
<td><p>1011.2888478205701</p></td>
</tr>
<tr class="row-even"><td><p>p50</p></td>
<td><p>1016.5285369580786</p></td>
</tr>
<tr class="row-odd"><td><p>p75</p></td>
<td><p>1021.4751151837601</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="_images/home_pressure.png"><img alt="_images/home_pressure.png" class="align-center" src="_images/home_pressure.png" style="width: 560.0px; height: 240.0px;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>min</p></td>
<td><p>0.0</p></td>
</tr>
<tr class="row-even"><td><p>max</p></td>
<td><p>22.91</p></td>
</tr>
<tr class="row-odd"><td><p>mean</p></td>
<td><p>6.649935544045547</p></td>
</tr>
<tr class="row-even"><td><p>stddev</p></td>
<td><p>3.9822204733738173</p></td>
</tr>
<tr class="row-odd"><td><p>p25</p></td>
<td><p>3.665238739924194</p></td>
</tr>
<tr class="row-even"><td><p>p50</p></td>
<td><p>5.923371960965267</p></td>
</tr>
<tr class="row-odd"><td><p>p75</p></td>
<td><p>8.936888719278361</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="_images/home_wind_speed.png"><img alt="_images/home_wind_speed.png" class="align-center" src="_images/home_wind_speed.png" style="width: 560.0px; height: 240.0px;" /></a>
</section>
</section>
<section id="feature-engineering">
<h2>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline"></a></h2>
<p>Now let’s work on the features. We will use three feature for the model:</p>
<ul class="simple">
<li><p>The ratio between pressure and wind speed.</p></li>
<li><p>The temperature value</p></li>
<li><p>The standard deviation of the temperature on the previous 6 hours.</p></li>
</ul>
<p>Moreover, we will compute one feature for each hour. Since the dataset has been
sampled every minute, we will reduce the size of a ratio of 60. Let’s work on
this step by step. The first thing is to declare a data type for these features:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Features</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Features&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;pspeed_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature_stddev&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>As a first step, we can compute the pressure/speed ratio, and save the current temperature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">Features</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">,</span>
        <span class="n">pspeed_ratio</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">pressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">temperature_stddev</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)),</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The input of the map operator is items for each line of the dataset, the output
is Feature items, one for each entry in the dataset. Note that the temperature
standard deviation is set to 0 for now.</p>
<p>The second step is to compute a rolling window of 6 hours, with a stride of one
hour. This is a type of transformation that is hard - or impossible - to
implement in most dataframe oriented frameworks. RxSci has a dedicated operator
for this common operation on time series: <a class="reference external" href="https://www.makinage.org/doc/rxsci/latest/reference_data.html#rxsci.data.roll">roll</a>.
It takes three arguments as input: The size of the window, the size of stride,
and the computation graph.</p>
<p class="marble">
<img src="_images/marble-860797c0d5f33819decee4c3099f5b2e8359ff11.png" alt="roll"/>
</p>
<p>Here is how we can use it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">a_pipeline</span><span class="p">)</span>
</pre></div>
</div>
<p>We need a pipeline that returns the last value of pspeed_ratio and temperature
on one side, and the standard deviation of the temperature on the other side. So
we also need the <em>tee_map</em> operator to compute them in parallel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">tee_map</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last</span><span class="p">(),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This computation graph returns the last item emitted by the source observable
and the standard deviation of the temperature field. We can now use it in the
rolling window:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">pipeline</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">tee_map</span><span class="p">(</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last</span><span class="p">(),</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">),</span>
</pre></div>
</div>
<p>The roll operator creates a new Observable for each window, so the <em>tee_map</em>
computation is done for each of these generated windows.</p>
<p>The complete code is:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-0-0-0" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="-1">Reactivity diagram</button></div><div aria-labelledby="tab-0-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-0-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">Features</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Features&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;pspeed_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature_stddev&#39;</span><span class="p">])</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">Features</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">,</span>
        <span class="n">pspeed_ratio</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">pressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">temperature_stddev</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">with_memory_store</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span>
            <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">tee_map</span><span class="p">(</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last</span><span class="p">(),</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">Features</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pspeed_ratio</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>todo: reactivity diagram</p>
</div></div>
<p>There are several other additions to this code. First, the <em>roll</em> operator can
be used only within the context of a <em>state store</em>. The reason is that roll is
one of the operators that work only on MuxObservables, a specialized
implementation of Observables optimized for aggregate and stateful transforms.</p>
<p>Then the final map transformation may require some clarifications. Its source
Observable contains tuples emitted by the roll operator. These are tuples of two
fields. The first one is the last <em>Features</em> item received on each window. The
second one is the temperature standard deviation. So the map operator creates
new feature items from the label, pspeed_ratio, and temperature from the first
element; and the standard deviation from the second element.</p>
<p>Finally, the <em>to_pandas</em> operator transforms the final Observable into a pandas
dataframe. This is a way to get out of RxSci and continue the processing with
other tools.</p>
</section>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Permalink to this headline"></a></h2>
<p>This step does not involve Maki Nage but we present it as an end-to-end example.
We will use a linear regression from scikit-learn:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pspeed_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature_stddev&#39;</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<p>And print the RMSE of the generated model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">pred</span><span class="p">)))</span>
<span class="mf">0.9800074715106518</span>
</pre></div>
</div>
</section>
<section id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline"></a></h2>
<p>Maki Nage comes with tools to ease the deployment of data transformation and
models. This part is based on <a class="reference external" href="https://kafka.apache.org/">Kafka</a>, a
distributed streaming platform. Kafka requires a broker to be installed, usually
on a cluster. For tests or work on a single machine, you can use the docker
environment provided by Maki Nage. Let’s start a local Kafka cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">git clone https://github.com/maki-nage/docker.git</span>
<span class="go">cd docker/compose/mn-dev</span>
<span class="go">docker-compose up -d kafka</span>
</pre></div>
</div>
<p>Deployment requires that the code is available as a python package. You can
retrieve and install a package containing the code of all examples this way:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">git clone https://github.com/maki-nage/makinage-examples.git</span>
<span class="go">cd makinage-examples</span>
<span class="go">python setup.py develop</span>
</pre></div>
</div>
<section id="id1">
<h3>Feature Engineering<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<p>The feature engineering code for the deployment is the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_house_features</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">csv</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">parser</span><span class="p">),</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">Features</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">house_overall</span><span class="p">,</span>
            <span class="n">pspeed_ratio</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">pressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">wind_speed</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">temperature_stddev</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)),</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">with_memory_store</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span>
                <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">pipeline</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">tee_map</span><span class="p">(</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last</span><span class="p">(),</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)),</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">Features</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pspeed_ratio</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span><span class="p">,</span>
</pre></div>
</div>
<p>This is the same code that we wrote during the feature engineering part, with
only 4 minor changes.</p>
<p>First, the code is embedded in a function taking two arguments: The first one is
an Observable of the configuration of the application (its usage is explained
later). The second one is an Observable of the data. Each row is received from
this observable instead of being read from a file.</p>
<p>As a consequence, the second change is that the CSV is not read from the file,
but each row is parsed from the data Observable. The <em>csv.load</em> operator is used
instead of <em>csv.load_from_file</em>.</p>
<p>The third change is the removal of the <em>to_list</em> operator: There is no need to
aggregate all items in a single list. The application work in streaming mode:
The is a stream of events as input (the rows of the CSV dataset), and it returns
a stream of events (the computed features). The source and the sink are Kafka
topics. If you are not familiar with Kafka, you can consider for now that a
Kafka topic is equivalent to an Observable.</p>
<p>The last change is the fact that we return a tuple, containing the output
Observables of the application. In this case, there is a single Observable.</p>
<p>To execute this application, a configuration file is needed. This YAML
file contains information on how to execute the application:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">application</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">house_features</span><span class="w"></span>
<span class="nt">kafka</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="w"></span>
<span class="nt">topics</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">house_values</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">encoder</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">makinage.encoding.string</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">start_from</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beginning</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">house_features</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">encoder</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">makinage.encoding.json</span><span class="w"></span>
<span class="nt">operators</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">compute_house_features</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">factory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">makinage_examples.house.features:compute_house_features</span><span class="w"></span>
<span class="w">        </span><span class="nt">sources</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">house_values</span><span class="w"></span>
<span class="w">        </span><span class="nt">sinks</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">house_features</span><span class="w"></span>
</pre></div>
</div>
<p>The <em>application</em> section defines the name of the application. The <em>kafka</em>
section contains the Kafka cluster configuration. The <em>topics</em> section contains
the list of the Kafka topics being used, as well as how they are used. Here we
encode the house_values items as strings and the house_features items as JSON.</p>
<p>The <em>operators</em> section contains the list of operators to run. A Maki Nage
operator is simply a function that processes some streams. There can be many
operators running on the same application. Each operator is described with three
information:</p>
<ul class="simple">
<li><p>The function to execute (<em>factory</em>). This function must be available from a python package.</p></li>
<li><p>The source streams used by the operator (sources).</p></li>
<li><p>The sink streams produced by the operator (sinks).</p></li>
</ul>
<p>Now we can start the application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">makinage --config config.house.yml</span>
</pre></div>
</div>
<p>This will initialize all kafka configuration, call the <em>compute_house_features</em>
function with the correct parameters, and run forever.</p>
<p>To make our application do something, we must inject some data on the
Kafka source topic (house_values). This can be done with another application
available in the example repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">makinage --config config.house.push.yml</span>
</pre></div>
</div>
</section>
<section id="model-serving">
<h3>Model Serving<a class="headerlink" href="#model-serving" title="Permalink to this headline"></a></h3>
<p>TODO</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="handson.html" class="btn btn-neutral float-left" title="Hands-on" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="handson_lanl.html" class="btn btn-neutral float-right" title="Lanl" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, R. Picard.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>